<%inherit file="base.html"/>

<%def name="body()">
<div id="container" class="container stretch">

        <div class="row title-container">
                <div class="col-1 logo-image">
                </div>
                <div class="col">
                    <h4 class="text-center text-nowrap title">SpeakReader Management Console</h4>
                </div>
                <div class="col-1">
                </div>
        </div>

        <div class="row">

            <!-- Nav tabs -->
            <nav id="navbar" class="navbar navbar-expand-sm mt-1 mb-1 pt-1 pb-1">

                <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarToggler" aria-controls="navbarToggler" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="fas fa-bars fa-lg"></span>
                </button>

                <div class="collapse navbar-collapse" id="navbarToggler">
                    <ul class="navbar-nav mr-auto nav-pills mt-1 mb-1" role="tablist">
                        <li class="nav-item"><a class="nav-link active" data-toggle="pill" href="#tabs-status" role="tab" aria-controls="tabs-status" aria-selected="true">Status</a></li>
                        <li class="nav-item"><a class="nav-link"        data-toggle="pill" href="#tabs-settings" role="tab" aria-controls="tabs-settings" aria-selected="false">Settings</a></li>
                        <li class="nav-item"><a class="nav-link"        data-toggle="pill" href="#tabs-transcripts" role="tab" aria-controls="tabs-transcripts" aria-selected="false">Transcripts</a></li>
                        <li class="nav-item"><a class="nav-link"        data-toggle="pill" href="#tabs-logs" role="tab" aria-controls="tabs-logs" aria-selected="false">Logs</a></li>
                    </ul>
                </div>

                <a id="signout-button" class="signout-button" style="display: ${'none' if config['http_username'] == '' else 'inline'}" href="/auth/logout">Sign Out</a>

            </nav>
        </div>

            <div class="tab-content">

                <div id="tabs-status" class="tab-pane fade show active mt-1" role="tabpanel" aria-labelledby="tabs-status-tab">

                    <div class="row">
                        <div class="col">
                            <div class="d-sm-flex flex-row justify-content-between">
                                <div class="col-md-3 col-sm-2 btn-group order-0 pl-2 pr-2" role="group" aria-label="btn1">
                                    <button type="button" id="tes-button" class="btn btn-primary" value="start">Start</button>
                                </div>

                                <div class="col-md-3 col-sm-3 btn-group order-2 pl-2 pr-2" role="group" aria-label="btn2">
                                    <button type="button" id="restart-button" class="btn btn-primary" value="restart" >Restart</button>
                                    <button type="button" id="shutdown-button" class="btn btn-primary" value="shutdown">Shutdown</button>
                                </div>

                                <div class="col-md-6 col-sm-7 text-center align-middle order-1 pl-2 pr-2">
                                    <div class="status-view-container">
                                        <p class="status-view-title font-weight-bold">Monitor</p>
                                        <div class="d-flex justify-content-around align-items-center mb-1" role="radiogroup">
                                            <label class="radio-inline d-flex align-items-center mb-0 ml-2 mr-2"><input type="radio" class="mr-1" name="status_view" value="listeners">Listeners</label>
                                            <label class="radio-inline d-flex align-items-center mb-0 ml-2 mr-2"><input type="radio" class="mr-1" name="status_view" value="transcript" checked>Transcript</label>
                                            <label class="radio-inline d-flex align-items-center mb-0 ml-2 mr-2"><input type="radio" class="mr-1" name="status_view" value="console">Console</label>
                                        </div>
                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>

                    <div class="row mt-2 mb-2">
                        <div class="col-5 text-nowrap">
                            <span class="font-weight-bold text-nowrap">Transcribe Engine Status: </span><span id="tes-status" class="text-nowrap"></span>
                        </div>
                        <div class="col text-md-right text-sm-left text-nowrap listeningOn-div">
                            <span class="font-weight-bold text-nowrap">Listening On: </span><span id="listeningOn" class="text-nowrap"></span>
                        </div>
                    </div>

                    <div id="listeners-container" class="row stretch">
                        <div class="col-sm-6 pr-sm-2 pt-1">
                            <div class="status-card">
                                <div class="status-card-title">Transcript Listeners</div>
                                <div class="status-card-count">
                                    <span>Count: </span><span id="transcript-listener-count"></span>
                                </div>
                                <div class="status-card-table-container">
                                    <table id="transcript-listener-table" class="status-card-table"></table>
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-6 pl-sm-2 pt-1">
                            <div class="status-card">
                                <div class="status-card-title">Log Listeners</div>
                                <div class="status-card-count">
                                    <span>Count: </span><span id="log-listener-count"></span>
                                </div>
                                <div class="status-card-table-container">
                                    <div id="log-listener-table" class="status-card-table"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div style="position: relative;">
                        <button id="bottom-button" class="bottom-button"><i class="fas fa-chevron-down"></i></button>
                        <div id="transcript-container" class="transcript-container listen-content stretch">
                            <div id="transcript" class="transcript">
                                <p></p>
                            </div>
                        </div>

                        <div id="transcript-settings" class="transcript-settings">
                            <div class="row">
                                <div class="col text-center">
                                    <div class="d-inline-block h-100 pr-3">
                                        <button id="fontsize-button-down" class="fontsize-button-down fontsize-button">A-</button>
                                        <button id="fontsize-button-up" class="fontsize-button-up fontsize-button">A+</button>
                                    </div>
                                    <div class="d-inline-block h-100 pl-3">
                                        <button id="light-theme" class="light color-theme-button" value="light"><i class="fas"></i></button>
                                        <button id="dark-theme" class="dark color-theme-button" value="dark"><i class="fas"></i></button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div style="position: relative;">
                        <button id="log-bottom-button" class="bottom-button"><i class="fas fa-chevron-down"></i></button>
                        <div id="log-container" class="log-container stretch">
                            <div id="console-log" class="console-log">
                                <p></p>
                            </div>
                        </div>
                    </div>

                </div>

                <div id="tabs-settings" class="tab-pane fade" role="tabpanel" aria-labelledby="tabs-settings-tab">

                    <div class="row">
                        <div class="col">
                            <div class="product-info-container">
                                <div class="row">
                                    <div class="col">
                                        <span class="d-block font-weight-bold">Product Information</span>
                                        <a id="changelog-modal-link" class="d-block ml-2 release-url" href="#">${productInfo['product']} ${productInfo['current_version']}</a>
                                    </div>
                                    <div class="col mt-auto mb-auto" id="check-for-update" style="display: none;">
                                            <button id="check-for-update-button" class="btn btn-primary text-nowrap float-right mr-3 check-for-update-button">Check for Updates</button>
                                    </div>
                                    <div class="col" id="update-available" style="display: none;">
                                            <span id="latest-release" class="d-block text-right font-weight-bold"><a class="release-url" target="_blank" href="${productInfo['latest_release_url']}">Update Available: ${productInfo['latest_release']}</a></span>
                                            <button id="update-now-button" class="btn btn-primary text-nowrap float-right mr-3 update-now-button">
                                                <span id="update-now-spinner" class="fas fa-sync"></span>
                                                <span id="update-now-button-text"> Update Now</span>
                                            </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="settings-container" class="row stretch settings-container">
                        <div class="col-sm">
                            <form action="configUpdate" method="post" class="form" id="configForm" validated="true">
                                <div id="config-container" class="config-container">
                                    <div class="form-section">
                                        <div class="col">
                                            <div class="padded-header">
                                                <h4>General</h4>
                                            </div>
                                            <div class="form-group">
                                                <label for="inputDeviceSelection" class="font-weight-bold">Input Device Selection</label>
                                                <select id="inputDeviceSelection" class="form-control col-md-6 col-sm-8" name="input_device"></select>
                                                <small class="form-text">Select the microphone or line-in input device that SpeakReader will listen on.</small>
                                            </div>

                                            <div class="form-group form-check">
                                                <input id="show_interim_results" type="checkbox" class="form-check-input" name="show_interim_results" value="1" checked="${config['show_interim_results']}"/>
                                                <label for="show_interim_results" class="font-weight-bold form-check-label">Show Interim Results</label>
                                                <small class="form-text">Show interim result text during transcription. Unchecking this will only show the final result text.</small>
                                            </div>

                                            <div class="form-group form-check">
                                                <input id="start_transcribe_on_startup" type="checkbox" class="form-check-input" name="start_transcribe_on_startup" value="1" checked="${config['start_transcribe_on_startup']}"/>
                                                <label for="start_transcribe_on_startup" class="font-weight-bold form-check-label">Start Transcribe Engine on Startup</label>
                                                <small class="form-text">Automatically start the Transcribe Engine when SpeakReader starts.</small>
                                            </div>

                                            <div class="form-group form-check">
                                                <input id="launch_browser" type="checkbox" class="form-check-input" name="launch_browser" value="1" checked="${config['launch_browser']}"/>
                                                <label for="launch_browser" class="font-weight-bold form-check-label">Launch Management Console on Startup</label>
                                                <small class="form-text">Launch a web browser with the SpeakReader Management Console on startup.</small>
                                            </div>

                                            <div class="form-group form-check">
                                                <div>
                                                    <input id="enable_censorship" type="checkbox" class="form-check-input" name="enable_censorship" value="1" checked="${config['enable_censorship']}"/>
                                                    <label for="enable_censorship" class="font-weight-bold form-check-label">Enable Censorship</label>
                                                    <small class="form-text">Enable profanity filters and censorship.</small>
                                                </div>
                                                <div class="form-sub-group">
                                                    <button id="censored-words-button" class="btn btn-primary censored-words-button">Edit</button>
                                                    <label for="censored-words-button" class="font-weight-bold">Edit Censored Words List</label>
                                                    <small class="form-text">Optional: Define additional words you never want to see in the transcript.</small>
                                                </div>
                                            </div>

                                            <div class="form-group">
                                                <label for="credentials_file" class="font-weight-bold">GoogleAPI Credentials JSON File</label>
                                                <div class="input-group">
                                                    <input id="credentials_file" class="form-control col-md-11" type="text" name="credentials_file" value="${config['credentials_file']}">
                                                    <div class="input-group-append">
                                                        <button id="upload_credentials_button" class="btn btn-secondary">Upload</button>
                                                    </div>
                                                </div>
                                                <div id="credentials_file_error" class="alert alert-danger" role="alert"></div>
                                                <small class="form-text">Required: Select and Upload your GoogleAPI JSON credentials file.</small>
                                                <input id="upload_credentials_file" type="file" name="upload_credentials_file" style="display: none;" />
                                            </div>

                                            <div class="form-group">
                                                <label for="log_dir" class="font-weight-bold">Logs Folder</label>
                                                <input id="log_dir" type="text" class="form-control" name="log_dir" value="${config['log_dir']}" size="30">
                                                <small class="form-text">Optional: Change the folder where you would like SpeakReader to store the SpeakReader console logs.<br><strong>Restart Required.</strong> A change here will become active with the next restart.</small>
                                            </div>

                                            <div class="form-group">
                                                <label for="transcripts_folder" class="font-weight-bold">Transcripts Folder</label>
                                                <input id="transcripts_folder" type="text" class="form-control" name="transcripts_folder" value="${config['transcripts_folder']}" size="30">
                                                <small class="form-text">Optional: Change the folder where you would like SpeakReader to store the transcripts.<br><strong>Restart Required.</strong> A change here will become active with the next restart.</small>
                                            </div>


                                            <div class="form-group form-check">
                                                <div>
                                                    <input id="save_recordings" type="checkbox" class="form-check-input" name="save_recordings" value="1" checked="${config['save_recordings']}"/>
                                                    <label for="save_recordings" class="font-weight-bold form-check-label">Save Audio Recordings</label>
                                                    <small class="form-text">Save Audio Recordings as wav files.</small>
                                                </div>

                                                <div class="form-sub-group">
                                                    <label for="recordings_folder" class="font-weight-bold">Recordings Folder</label>
                                                    <input id="recordings_folder" type="text" class="form-control" name="recordings_folder" value="${config['recordings_folder']}" size="30">
                                                    <small class="form-text">Optional: Change the folder where you would like SpeakReader to store the audio recordings.<br><strong>Restart Required.</strong> A change here will become active with the next restart.</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="form-section">
                                        <div class="col">
                                            <div class="padded-header">
                                                <h4>Web Interface</h4>
                                            </div>

                                            <div class="form-group">
                                                <label for="http_port" class="font-weight-bold">HTTP Port</label>
                                                <div class="row">
                                                    <div class="col-md-2 col-sm-3 col-4">
                                                        <input id="http_port" type="text" class="form-control" name="http_port" value="${config['http_port']}" required>
                                                    </div>
                                                    <div id="http_port_error" class="alert alert-danger" role="alert"></div>
                                                </div>
                                                <small class="form-text">Port to bind the web server to. Note that ports below 1024 may require root authority.<br><strong>Changing this value will restart SpeakReader.</strong></small>
                                            </div>

                                            <div class="form-group form-check">
                                                <div>
                                                    <input id="enable_https" type="checkbox" class="form-check-input" name="enable_https" value="1" checked="${config['enable_https']}"/>
                                                    <label for="enable_https" class="font-weight-bold form-check-label">Enable HTTPS</label>
                                                    <small class="form-text">Enable HTTPS for the web server to use encrypted communication.<br><strong>Changing protocols will require restarting SpeakReader.</strong></small>
                                                </div>
                                                <div class="form-sub-group">
                                                    <div class="form-sub-group">
                                                        <label for="https_cert" class="font-weight-bold">HTTPS Certificate</label>
                                                        <input type="text" class="form-control http-settings" id="https_cert" name="https_cert" value="${config['https_cert']}" />
                                                        <small class="form-text">The location of the SSL certificate.</small>
                                                    </div>

                                                    <div class="form-sub-group">
                                                        <label for="https_key" class="font-weight-bold">HTTPS Key</label>
                                                        <input type="text" class="form-control http-settings" id="https_key" name="https_key" value="${config['https_key']}" />
                                                        <small class="form-text">The location of the SSL key.</small>
                                                    </div>

                                                    <div class="form-sub-group">
                                                        <label for="https_cert_chain" class="font-weight-bold">HTTPS Certificate Chain</label>
                                                        <input type="text" class="form-control http-settings" id="https_cert_chain" name="https_cert_chain" value="${config['https_cert_chain']}" />
                                                        <small class="form-text">The location of the SSL certificate chain. Optional if the certificate file does not contain the full chain.</small>
                                                    </div>

                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="form-section">
                                        <div class="col">
                                            <div class="padded-header">
                                                <h4>Authentication</h4>
                                            </div>

                                            <div class="form-group">
                                                <label for="http_username" class="font-weight-bold">HTTP Username</label>
                                                <div class="row">
                                                    <div class="col-md-4 col-sm-5 col-6">
                                                        <input id="http_username" type="text" class="form-control" name="http_username" value="${config['http_username']}" />
                                                    </div>
                                                    <div id="http_username_error" class="alert alert-danger" role="alert"></div>
                                                </div>
                                                <small class="form-text">Username for SpeakReader Management Console authentication. Leave empty to disable.</small>
                                            </div>

                                            <div class="form-group">
                                                <label for="http_password" class="font-weight-bold">HTTP Password</label>
                                                <div class="row">
                                                    <div class="col-md-4 col-sm-5 col-6">
                                                        <input id="http_password" type="password" class="form-control" name="http_password" value="">
                                                        <input id="set_http_password" type="hidden" name="set_http_password" value="0">
                                                    </div>
                                                    <div id="http_password_error" class="alert alert-danger" role="alert"></div>
                                                </div>
                                                <small class="form-text">Password for SpeakReader Management Console authentication. Leave empty to disable.</small>
                                            </div>

                                            <div class="form-group form-check">
                                                <div class="row">
                                                    <div class="col">
                                                        <input id="http_hash_password" type="checkbox" class="form-check-input" name="http_hash_password" value="1" checked="${config['http_hash_password']}"/>
                                                        <label for="http_hash_password" class="font-weight-bold form-check-label">Hash Password in the Config File</label>
                                                    </div>
                                                    <div id="http_hash_password_error" class="alert alert-danger" role="alert"></div>
                                                </div>
                                                <small class="form-text">Store a hashed password in the config file.<br />Warning: Your password cannot be recovered if forgotten!</small>
                                            </div>

                                            <div class="form-group form-check">
                                                <input id="http_basic_auth" type="checkbox" class="form-check-input" name="http_basic_auth" value="1" checked="${config['http_basic_auth']}"/>
                                                <label for="http_basic_auth" class="font-weight-bold form-check-label">Use Basic Authentication</label>
                                                <small class="form-text">Use basic HTTP authentication instead of the HTML login form.!</small>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="form-section">
                                        <div class="col">
                                            <div class="padded-header">
                                                <h4>Updates</h4>
                                            </div>

                                            <div class="form-group form-check">
                                                <div>
                                                    <input id="check_github" type="checkbox" class="form-check-input" name="check_github" value="1" checked="${config['check_github']}" />
                                                    <label for="check_github" class="font-weight-bold form-check-label">Enable Updates</label>
                                                    <div id="check_github_error" class="alert alert-danger" role="alert"></div>
                                                    <small class="form-text">Enable support for updating SpeakReader.</small>
                                                </div>

                                                <div class="form-sub-group">
                                                    <div class="form-sub-group">
                                                        <label for="git_token" class="font-weight-bold">GitHub API Token</label>
                                                        <input id="git_token" type="text" class="form-control col-lg-6 col-md-8 col-sm-9 col-12" name="git_token" value="${config['git_token']}" />
                                                        <div id="git_token_error" class="alert alert-danger" role="alert"></div>
                                                        <small class="form-text">Optional: Use your own GitHub API token when checking for updates.</small>
                                                    </div>

                                                    % if config['install_type'] == 'git':
                                                    <div class="form-sub-group">
                                                        <label for="git_branch" class="font-weight-bold">Git Remote / Branch</label>
                                                        <div class="row">
                                                            <div class="col-lg-5 col-md-7 col-sm-9 col-12">
                                                                <div class="input-group git-group">
                                                                    <input type="text" class="form-control" id="git_remote" name="git_remote" value="${config['git_remote']}">
                                                                    <select class="form-control" id="git_branch" name="git_branch">
                                                                        <% branches = ('master', 'beta', 'nightly') %>
                                                                        % for branch in branches:
                                                                        <option value="${branch}" ${'selected' if config['git_branch'] == branch else ''}>${branch}</option>
                                                                        % endfor
                                                                        % if config['git_branch'] not in branches:
                                                                        <option value="${config['git_branch']}" selected>${config['git_branch']}</option>
                                                                        % endif
                                                                    </select>
                                                                    <span class="input-group-btn">
                                                                        <button class="btn btn-primary" type="button" id="switch_git_branch">Checkout Branch</button>
                                                                    </span>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <small class="form-text">The git tracking remote and branch (default "origin/master"). Select to switch the git branch (requires restart).</small>
                                                    </div>

                                                    <div class="form-sub-group">
                                                        <label for="git_path" class="font-weight-bold">Git Path</label>
                                                        <input type="text" class="form-control col-lg-6 col-md-8 col-sm-9 col-12" id="git_path" name="git_path" value="${config['git_path']}" size="30">
                                                        <small class="form-text">Optional: The path to your git environment variable. Leave blank for default.</small>
                                                        <div id="git_path_error" class="alert alert-danger" role="alert"></div>
                                                    </div>
                                                    % endif

                                                </div>
                                            </div>

                                        </div>
                                    </div>

                                    <div class="col" role="group">
                                        <button id="save-button" class="btn btn-primary save-button">Save</button>
                                        <label for="save-button" class="font-weight-bold">Save your configuration changes.</label>
                                    </div>

                                </div>

                                <div id="censored-words-container" class="censored-words-container" style="display: none; z-index: 999;">
                                    <div class="row">
                                        <div class="col">
                                            <h4 class="text-center">Censored Words</h4>
                                            <p>If the Enable Censorship configuration option is checked, words or phrases on this list will be censored from the transcript in addition to the words censored by the speech-to-text API profanity filter.<br>Place each word or series of words on separate lines.</p>
                                            <textarea id="censored_words" rows="20" cols="1" name="censored_words" style="width: 100%;"></textarea>
                                        </div>
                                        <button id="close-censored-words" class="close-button"><i class="fas fa-times"></i></button>
                                    </div>
                                </div>

                            </form>
                        </div>
                    </div>

                </div>

                <div id="tabs-transcripts" class="tab-pane fade" role="tabpanel" aria-labelledby="tabs-transcripts-tab">
                    <div id="transcripts-list-container" class="row stretch">
                        <div class="col">
                            <table id="transcripts-list" class="display hover row-border stripe text-nowrap pr-0" style="width: 100%"></table>
                        </div>
                    </div>

                    <div id="view-transcript-container">
                        <div class="row mb-2">
                            <div class="col-10">
                                <span id="view-transcript-filename" class="view-filename text-nowrap mt-2 ml-3"></span>
                            </div>
                        </div>
                        <div style="position: relative;">
                            <button id="close-transcript" class="btn btn-secondary close-button"><i class="fas fa-times"></i></button>
                            <div class="transcript-view-container stretch">
                                <div id="view-transcript" class="transcript view-transcript"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="tabs-logs" class="tab-pane fade" role="tabpanel" aria-labelledby="tabs-logs-tab">
                    <div id="logs-list-container" class="row stretch">
                        <div class="col">
                            <table id="logs-list" class="display hover row-border stripe text-nowrap pr-0" style="width: 100%"></table>
                        </div>
                    </div>

                    <div id="view-log-container">
                        <div class="row mb-2">
                            <div class="col">
                                <span id="view-log-filename" class="view-filename text-nowrap mt-2 ml-3"></span>
                            </div>
                        </div>
                        <div style="position: relative;">
                            <button id="close-log" class="btn btn-secondary close-button"><i class="fas fa-times"></i></button>
                            <div class="log-view-container stretch">
                                <div id="view-log" class="console-log view-log"></div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>

    </div>
</%def>

<%def name="modalIncludes()">
<div id="changelog-modal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="changelog-modal">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Changelog</h4>
            </div>
            <div class="modal-body">
            </div>
            <div class="modal-footer">
                <input type="button" class="btn btn-primary" data-dismiss="modal" value="Close">
            </div>
        </div>
    </div>
</div>

<div id="confirm-modal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="confirm-modal">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Confirm</h4>
            </div>
            <div class="modal-body">
                <div id="confirm-message" style="text-align: center; margin-top: 20px; margin-bottom: 20px;">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-dark" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger btn-ok" data-dismiss="modal" id="confirm-button">Confirm</button>
            </div>
        </div>
    </div>
</div>
</%def>

<%def name="javascriptIncludes()">
<script>
// Global Variables
var logStream = "";
var prev_username = "";
var prev_hashed_password = "";
var update_available = ${productInfo['update_available']};
var transcripts_table = false;
var logs_table = false;


function startLogStream() {
    // Create Log Stream.
    logStream = new EventSource('/addListener?type=log');
    logStream.onmessage = function (e) {
        var data = JSON.parse(e.data);

        switch (data.event) {
            case 'ping':
                return;

            case 'open':
                sessionID = data.sessionID;
                break;

            case 'close':
                logStream.close();
                logStream = "";
                break;

            case 'logrecord':
                var atBottom = $('#console-log').parent().prop("scrollTop") + $('#console-log').parent().prop("clientHeight") >= $('#console-log').parent().prop("scrollHeight");

                if ( data.final === "reload" ) {
                    $('#console-log').html(data.record);
                } else {
                    $('#console-log').append('<p>' + data.record + '</p>');
                }

                if ( atBottom ) {
                    $('#console-log').parent().scrollTop($('#console-log').prop("scrollHeight"));
                }

                break;
        };
    };
};

function stopLogStream() {
    if ( logStream !== "" && logStream.readyState === 1 ) {
        navigator.sendBeacon("removeListener", JSON.stringify({"type": "log", "sessionID": sessionID}));
    }
};

function setStatusView() {
    var statusView = $('input[type=radio][name=status_view]:checked').val();
    setCookie("statusView", statusView, 365);
    $('#transcript-settings').slideUp();
    switch (  statusView ) {
        case 'listeners':
            stopTranscriptStream();
            stopLogStream();
            $('#listeners-container').show();
            $('#transcript-container').hide();
            $('#log-container').hide();
            break;

        case 'transcript':
            stopLogStream();
            $('#listeners-container').hide();
            $('#log-container').hide();
            $('#transcript-container').show();
            startTranscriptStream();
            break;

        case 'console':
            stopTranscriptStream();
            $('#listeners-container').hide();
            $('#transcript-container').hide();
            $('#log-container').show();
            startLogStream();
            break;
    }
    resizeContainers();
};

function resizeContainers() {

    // Set the size of the stretched containers
    $('.stretch:visible').each( function() {
        var e = $(this)[0];
        var height = window.innerHeight;
        do {
            height -= e.offsetTop + parseInt($(e).css("margin-bottom")) + parseInt($(e).css("padding-bottom"));
            e = e.offsetParent;
        }
        while ( e !== null );
        $(this).height(height);
    });

};

function setLatestRelease(data) {
    $('#latest-release').html('<a class="release-url" target="_blank" href="' + data.latest_release_url + '">Update Available: ' + data.latest_release + '</a>');
    $('#check-for-update-button').html('<span>Check for Updates</span>');
    if ( data.update_available ) {
        update_available = true;
        $('#check-for-update').hide();
        $('#update-available').show();
    } else {
        update_available = false;
        $('#check-for-update').show();
        $('#update-available').hide();
    }
}

function checkForUpdate() {
    $('#check-for-update-button').html('<span><i class="fas fa-sync fa-spin"/> Checking</span>');
    $.getJSON('checkForUpdate', function (data, textStatus) {
        setLatestRelease(data)
    });
};

function postSaveChecks(jqXHR) {
    var response = JSON.parse(jqXHR.responseText);
    if ( response.portchanged ) {
        $("#confirm-message").text("SpeakReader needs to restart.");
        $('#confirm-modal').modal();
        $('#confirm-modal').one('click', '#confirm-button', function () {
            window.location.href = "restart";
        });
    }
    $('#listeningOn').text($('#inputDeviceSelection').val());
    $('#upload_credentials_file').val("");
    $('#http_password').val("");
    $('#set_http_password').val(0);
    $('#credentials_file').val(response.credentials_file);
    if ( response.logout ) {
        window.location.href = "auth/logout";
    }
    if ( $('#check_github').prop('checked') ) {
        if ( update_available ) {
            $('#check-for-update').hide();
            $('#update-available').show();
        } else {
            $('#check-for-update').show();
            $('#update-available').hide();
        }
    } else {
        $('#check-for-update').hide();
        $('#update-available').hide();
    }
    $('#settings-container').scrollTop(0);
};

function getSettings() {
    $.getJSON('getSettings', function (data, textStatus) {
        var config = data.config;

        // Check boxes
        $('#show_interim_results').prop('checked', config.show_interim_results);
        $('#start_transcribe_on_startup').prop('checked', config.start_transcribe_on_startup);
        $('#launch_browser').prop('checked', config.launch_browser);
        $('#enable_censorship').prop('checked', config.enable_censorship);
        $('#http_basic_auth').prop('checked', config.http_basic_auth);
        $('#http_hash_password').prop('checked', config.http_hash_password);
        $('#enable_https').prop('checked', config.enable_https);
        $('#check_github').prop('checked', config.check_github);
        $('#save_recordings').prop('checked', config.save_recordings);

        // Text Values
        $('#credentials_file').val(config.credentials_file);
        $('#transcripts_folder').val(config.transcripts_folder);
        $('#recordings_folder').val(config.recordings_folder);
        $('#log_dir').val(config.log_dir);
        $('#http_port').val(config.http_port);
        $('#https_cert').val(config.https_cert);
        $('#https_cert_chain').val(config.https_cert_chain);
        $('#https_key').val(config.https_key);
        $('#http_username').val(config.http_username);
        $('#hashed_password').val(config.hashed_password);
        $('#censored_words').val(config.censored_words);
        $('#git_token').val(config.git_token);
        $('#git_remote').val(config.git_remote);
        $('#git_path').val(config.git_path);

        $('#git_branch').val(config.git_branch);

        prev_username = config.http_username;
        prev_hashed_password = config.hashed_password;
        if ( config.http_username !== "" ) {
            $('#signout-button').show();
        } else {
            $('#signout-button').hide();
        }
        if ( config.check_github ) {
            if ( update_available ) {
                $('#check-for-update').hide();
                $('#update-available').show();
            } else {
                $('#check-for-update').show();
                $('#update-available').hide();
            }
        } else {
            $('#check-for-update').hide();
            $('#update-available').hide();
        }

        initConfigCheckbox('#save_recordings');
        initConfigCheckbox('#enable_https');
        initConfigCheckbox('#enable_censorship');
        initConfigCheckbox('#check_github');
    });
};

function saveSettings() {
    if ( $('#configForm').attr('validated') === 'true' ) {
        $.ajax({
            url: 'configUpdate',
            type: 'POST',
            dataType: 'JSON',
            data: new FormData($('#configForm')[0]),
            processData: false,
            contentType: false,
            complete: function (jqXHR, textStatus) {
                postSaveChecks(jqXHR);
            }
        });
    }
    return false;
};

function verifyAuthentication() {
    $('#configForm').attr('validated', 'false');
    var username = $('#http_username').val();
    var password = $('#http_password').val();
    $('#http_username_error').hide();
    $('#http_password_error').hide();
    $('#http_hash_password_error').hide();
    if ( username !== '' && password === '' ) {
        $('#http_password_error').html("<span>Password is required when Username is not blank.</span>").show();
        return false;
    }
    if ( username === '' && password !== '' ) {
        $('#http_username_error').html("<span>Username is required when Password is not blank.</span>").show();
        return false;
    }
    $('#configForm').attr('validated', 'true');
    return true;
}


$(document).ready(function() {

    var statusView = getCookie("statusView");
    if ( statusView !== "" ) {
        $('input[type=radio][name=status_view][value="' +statusView+ '"]').prop('checked', true);
        setCookie("statusView", statusView, 365);
    }
    setStatusView();
    window.addEventListener('resize', resizeContainers, true);

    window.addEventListener('beforeunload', function(event) {
        tesHandler.close();
        noSleep.disable();
        stopTranscriptStream();
        stopLogStream();
        return false;
    }, false);

    $('#upload_credentials_button').click(function(e) {
        e.preventDefault();
        $('#credentials_file_error').hide();
        $('#upload_credentials_file').trigger('click');
    });

    $('#upload_credentials_file').change(function(event) {
        $('#credentials_file').val(this.files[0].name);
        var reader = new FileReader();
        reader.onload = function onReaderLoad(event){
                console.log(event.target.result);
                $('#configForm').attr('validated', 'true');
                if ( !(isValidJson(event.target.result)) ) {
                    $('#credentials_file_error').html("<span>This file is not a valid JSON file.</span>").show();
                    $('#configForm').attr('validated', 'false');
                }
        }
        reader.readAsText(event.target.files[0]);
    });

    $('.navbar-toggler').click(function(){
        if ( $('#navbarToggler').hasClass('show') ) {
            $( '.navbar-collapse' ).collapse('hide');
            return false;
        }
    });

    $('.navbar-nav>li>a').click(function(){
	    $( '#navbar .navbar-nav' ).find( 'li.active' ).removeClass( 'active' );
	    $( '#navbar .nav-item' ).find( 'a.active' ).removeClass( 'active' );
	    $( this ).parent( 'li' ).addClass( 'active' );
        $( '.navbar-collapse' ).collapse('hide');
    });

    $('#save-button').click(function() {
        saveSettings();
        return false;
    });

    $('#shutdown-button').click(function() {
        $("#confirm-message").text("Are you sure you want to shutdown SpeakReader?");
        $('#confirm-modal').modal();
        $('#confirm-modal').one('click', '#confirm-button', function () {
            tesHandler.close();
            window.location.href = "shutdown";
        });
    });

    $('#restart-button').click(function() {
        $("#confirm-message").text("Are you sure you want to restart SpeakReader?");
        $('#confirm-modal').modal();
        $('#confirm-modal').one('click', '#confirm-button', function () {
            tesHandler.close();
            window.location.href = "restart";
        });
    });

    $('#tes-button').click(function() {
        if ( $(this).val() === "start") {
            $.ajax({url: "startTranscribe"});
        } else {
            $.ajax({url: "stopTranscribe"});
        }
    });

    // SSE handler for transcribeEngineStatus
    var tesHandler = new EventSource('transcribeEngineStatus');
    tesHandler.onmessage = function (e) {
        var data = JSON.parse(e.data);
        var tesStatus = data.status
        switch (tesStatus) {
            case "Close":
                tesHandler.close();
                break;

            case true:
                $('#tes-button').css("background-color", "green").text("Stop").val("stop");
                $('#tes-status').text("Online");
                $('.listeningOn-div').show();
                break;

            case false:
                $('#tes-button').css("background-color", "red").text("Start").val("start");
                $('#tes-status').text("Offline");
                $('.listeningOn-div').hide();
                break;
        }

        $('#transcript-listener-count').text(data.usage.transcript.count);
        var table = "";
        if ( data.usage.transcript.count > 0 ) {
            table = '<tbody>'
            for ( i = 0; i < data.usage.transcript.list.length; i++ ) {
                var item = data.usage.transcript.list[i];
                table += '<tr><td class="text-nowrap">' + item.remoteIP + ' - ' + item.sessionID + '</td></tr>';
            }
            table += '</tbody>'
        }
        $('#transcript-listener-table').html(table);

        $('#log-listener-count').text(data.usage.log.count);
        var table = "";
        if ( data.usage.log.count > 0 ) {
            table = '<table class="status-card-table" style="height: 100%;"><tbody>'
            for ( i = 0; i < data.usage.log.list.length; i++ ) {
                var item = data.usage.log.list[i];
                table += '<tr><td class="text-nowrap">' + item.remoteIP + ' - ' + item.sessionID + '</td></tr>';
            }
            table += '</tbody></table>'
        }
        $('#log-listener-table').html(table);
    };


    // Populate inputDeviceSelection with list of Input Devices
    $.getJSON('/get_input_device_list', function (result) {
        var inputDeviceSelection = $('#inputDeviceSelection');
        inputDeviceSelection.empty();
        if ( result.length === 0 ) {
            inputDeviceSelection.append($('<option></option>').text('No Devices Available'));
        }
        $.each(result, function (key, device) {
            inputDeviceSelection.append($('<option></option>').val(device.name).text(device.name));
            if (device.selected) {
                inputDeviceSelection.val(device.name).prop('selected', true);
            }
        })
        $('#listeningOn').text($('#inputDeviceSelection').val());
    });

    transcripts_table = $('#transcripts-list').DataTable({
        "paging": false,
        "scrollY": "100%",
        "scrollX": "100%",
        "scrollCollapse": true,
        "searching": false,
        "info": false,
        "ajax": { "url": "get_files_list",
                  "data": { "list": "transcripts" },
                },
        "ordering": true,
        "order": [ 2 , 'desc' ],
        "columns": [
            { "className": "dt-center p-0", "data": null, "orderable": false, "defaultContent": '<i style="width: 34px;" class="fas fa-eye view" data-toggle="tooltip" data-placement="top" title="View"></i>' },
            { "className": "dt-center p-0", "data": null, "orderable": false, "defaultContent": '<i style="width: 34px;" class="fas fa-download download" data-toggle="tooltip" data-placement="top" title="Download"></i>' },
            { "title": "File Name", "data": "name" },
            { "title": "Created", "data": "created" },
            { "className": "dt-center p-0", "data": null, "orderable": false, "defaultContent": '<i style="color: red; width: 34px;" class="fas fa-trash-alt delete" data-toggle="tooltip" data-placement="top" title="Delete"></i>' },
        ],
        "drawCallback": function( settings ) {
            $('[data-toggle="tooltip"]').tooltip();
        },
    });

    $('#transcripts-list tbody').on( 'click', 'i', function () {
        var data = transcripts_table.row( $(this).parents('tr') ).data();
        if ( $(this).hasClass("view") )   {
            $.ajax({
                url: 'view_file',
                dataType: 'JSON',
                data: { "transcript": data.name },
                complete: function (jqXHR, status) {
                    $('#view-transcript').html(jqXHR.responseJSON.data);
                    $('#transcripts-list-container').hide();
                    $('#view-transcript-container').show();
                    $('#view-transcript-filename').text(data.name);
                    resizeContainers();
                },
            });
        };

        if ( $(this).hasClass("delete") ) {
            $(this).tooltip('hide');
            $.ajax({
                url: 'delete_file',
                dataType: 'JSON',
                data: { "transcript": data.name },
                complete: function () { transcripts_table.ajax.reload(); },
            });
        };

        if ( $(this).hasClass("download") ) {
            window.location.href = "download_file?transcript=" + data.name;
        };
    });

    $('#close-transcript').click(function() {
        $('#view-transcript-container').hide();
        $('#transcripts-list-container').show();
        return false;
    });

    logs_table = $('#logs-list').DataTable({
        "paging": false,
        "scrollX": "100%",
        "scrollY": "100%",
        "scrollCollapse": true,
        "searching": false,
        "info": false,
        "ajax": { "url": "get_files_list",
                  "data": { "list": "logs" },
                },
        "ordering": true,
        "order": [ 2 , 'desc' ],
        "columns": [
            { "className": "dt-center p-0", "data": null, "orderable": false, "defaultContent": '<i style="width: 34px;" class="fas fa-eye view" data-toggle="tooltip" data-placement="top" title="View"></i>' },
            { "className": "dt-center p-0", "data": null, "orderable": false, "defaultContent": '<i style="width: 34px;" class="fas fa-download download" data-toggle="tooltip" data-placement="top" title="Download"></i>' },
            { "title": "File Name", "data": "name" },
            { "title": "Created", "data": "created" },
            { "className": "dt-center p-0", "data": null, "orderable": false, "defaultContent": '<i style="width: 34px; color: red;" class="fas fa-trash-alt delete" data-toggle="tooltip" data-placement="top" title="Delete"></i>' },
        ],
        "drawCallback": function( settings ) {
            $('[data-toggle="tooltip"]').tooltip();
        },
    });

    $('#logs-list tbody').on( 'click', 'i', function () {
        var data = logs_table.row( $(this).parents('tr') ).data();
        if ( $(this).hasClass("view") )   {
            $.ajax({
                url: 'view_file',
                dataType: 'JSON',
                data: { "log": data.name },
                complete: function (jqXHR, status) {
                    $('#view-log').html(jqXHR.responseJSON.data);
                    $('#view-log-filename').text(data.name);
                    $('#logs-list-container').hide();
                    $('#view-log-container').show();
                    resizeContainers();
                },
            });
        };

        if ( $(this).hasClass("delete") ) {
            $(this).tooltip('hide');
            $.ajax({
                url: 'delete_file',
                dataType: 'JSON',
                data: { "log": data.name },
                complete: function () { logs_table.ajax.reload(); },
            });
        };

        if ( $(this).hasClass("download") ) {
            window.location.href = "download_file?log=" + data.name;
        };
    });

    $( '.dataTables_scrollBody' ).addClass('stretch');

    $('#close-log').click(function() {
        $('#view-log-container').hide();
        $('#logs-list-container').show();
        return false;
    });

    $('#enable_https').click(function() {
        if ( $(this).prop('checked') && $('#http_port').val() == '80' ) {
            $('#http_port').val('443');
        }
        if ( !$(this).prop('checked') && $('#http_port').val() == '443' ) {
            $('#http_port').val('80');
        }
    });

    $('#close-censored-words').click(function() {
        $('#config-container').show();
        $('#censored-words-container').hide();
        return false;
    });

    $('#censored-words-button').click(function() {
        $('#config-container').hide();
        $('#censored-words-container').show();
        return false;
    });

    $('#update-now-button').click(function() {
        $("#confirm-message").text("Are you sure you want to update SpeakReader?");
        $('#confirm-modal').modal();
        $('#confirm-modal').one('click', '#confirm-button', function () {
            window.location.href = "update";
        });
    });

    $('#check-for-update-button').click(function() {
        checkForUpdate();
    });

    $('#http_port').change(function() {
        var port = $('#http_port').val();
        $('#http_port_error').hide();
        $('#configForm').attr('validated', 'false');

        if ( port === '' ) {
            $('#http_port_error').html("<span>Port is required.</span>").show();
            return;
        }
        var isNum = /^\d+$/.test(port);
        if ( isNum ) {
            port = parseInt(port);
        }
        if ( !isNum || ( isNum && ( port < 1 || port > 64535 ) ) ) {
            $('#http_port_error').html("<span>Port must be an integer between 1 and 65535.</span>").show();
            return;
        }
        $('#configForm').attr('validated', 'true');
    });

    $('#http_username').change(function() {
        if ( prev_username === "" ) {
            verifyAuthentication();
        }
    });

    $('#http_password').change(function() {
        if ( verifyAuthentication() ) {
            $("#set_http_password").val(1);
        }
    });

    $('#http_hash_password').change(function() {
        $('#configForm').attr('validated', 'false');
        $('#http_hash_password_error').hide();
        if ( !$(this).prop('checked')
        && prev_hashed_password === 1
        && $('#http_username').val() !== ""
        && $('#http_password').val() === "" ) {
            $('#http_hash_password_error').html("<span>New password must be set. Cannot unhash any existing password.</span>").show();
            return;
        }
        $('#configForm').attr('validated', 'true');

    });

    $('a[data-toggle="pill"]').on('shown.bs.tab', function (e) {
        $('#view-log-container').hide();
        $('#view-transcript-container').hide();
        var target = $(e.target).attr("href");
        switch ( target ) {
            case '#tabs-status':
                break;

            case '#tabs-settings':
                getSettings();
                break;

            case '#tabs-transcripts':
                transcripts_table.ajax.reload();
                $('#transcripts-list-container').show();
                $('#transcripts-list').DataTable().draw();
                break;

            case '#tabs-logs':
                logs_table.ajax.reload();
                $('#logs-list-container').show();
                $('#logs-list').DataTable().draw();
                break;
        }
        resizeContainers();
    });

    $("#switch_git_branch").click(function () {
        var current_remote = "${config['git_remote']}";
        var current_branch = "${config['git_branch']}";
        var new_remote = $("#git_remote").val();
        var new_branch = $("#git_branch option:selected").val();

        if (new_remote === current_remote && new_branch === current_branch) {
            //showMsg('<i class="fa fa-exclamation-circle"></i> Already on the ' + current_remote + ' ' + current_branch + ' branch.', false, true, 5000, true)
        } else {
            var msg = 'Are you sure you want to switch to the <strong>' + new_remote + '/' + new_branch + '</strong> branch?' +
                '<br />Switching branches may cause SpeakReader to become unstable.<br /><br />SpeakReaderi will restart.';
            $('#confirm-message').html(msg);
            $('#confirm-modal').modal();
            $('#confirm-modal').one('click', '#confirm-button', function () {
                window.location.href = 'checkout_git_branch?git_remote=' + new_remote + '&git_branch=' + new_branch;
            });
        }
    });

    $('#changelog-modal-link').click(function (e) {
        e.preventDefault();
        $.ajax({
            url: 'get_changelog',
            cache: false,
            async: true,
            complete: function(xhr, status) {
                $("#changelog-modal .modal-body").html(xhr.responseText);
                $('#changelog-modal').modal();
            }
        });
    });

    $('input[type=radio][name=status_view]').change(function() {
        setStatusView();
    });

    $('#log-bottom-button').click(function() {
        $('#console-log').parent().scrollTop($('#console-log').prop("scrollHeight"));
        return false;
    });

    $('#console-log').parent().scroll(function () {
        var atBottom = $('#console-log').parent().prop("scrollTop") + $('#console-log').parent().prop("clientHeight") >= $('#console-log').parent().prop("scrollHeight");
        if ( atBottom ) {
            $('#log-bottom-button').hide();
        } else {
            $('#log-bottom-button').show();
        }
    });


});

</script>
</%def>
